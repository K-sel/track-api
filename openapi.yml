openapi: 3.1.0
info:
  title: Track API
  version: 0.1.0
  description: |
    API REST pour le suivi d'activités sportives (course à pied) avec enrichissement automatique (météo, difficulté), statistiques détaillées et WebSocket temps réel.

    ## Fonctionnalités principales

    - **Gestion utilisateurs** : Inscription, authentification JWT, modification/suppression de compte
    - **Tracking GPS** : Enregistrement d'activités avec polyline encodée, laps, dénivelé, altitude
    - **Enrichissement automatique** : Météo (Open-Meteo), score de difficulté (1.0-2.0), estimation calories
    - **Analytics** : Statistiques annuelles/mensuelles/hebdomadaires, records personnels (5K, 10K, Semi, Marathon)
    - **Médias géolocalisés** : Gestion de photos/vidéos via Cloudinary (max 10/activité)
    - **WebSocket** : Statistiques communautaires en temps réel (km totaux, nombre d'utilisateurs actifs)

    ## Authentification

    L'API utilise **JWT (JSON Web Tokens)** pour l'authentification :
    - Durée de validité : 7 jours
    - Algorithme : HS256
    - Header requis : `Authorization: Bearer <token>`

    Pour obtenir un token, utilisez l'endpoint `/auth/login` avec vos identifiants.

    ## Rate Limiting

    Protection contre les abus sur les endpoints critiques :
    - **Création de compte** : 10 tentatives par heure par IP
    - **Login** : 20 tentatives par 5 minutes par IP

    Réponse en cas de dépassement : **HTTP 429** avec message d'erreur.

    ## Format des réponses

    Toutes les réponses suivent un format standardisé :

    ### Succès
    ```json
    {
      "success": true,
      "data": { ... },
      "meta": { ... }
    }
    ```

    ### Erreur
    ```json
    {
      "success": false,
      "error": {
        "message": "Description de l'erreur",
        "code": "ERR_CODE",
        "details": []
      }
    }
    ```

    ## Codes d'erreur standardisés

    - `ERR_UNAUTHORIZED` : Non authentifié
    - `ERR_INVALID_CREDENTIALS` : Email ou mot de passe incorrect
    - `ERR_INVALID_TOKEN` : Token JWT invalide ou expiré
    - `ERR_FORBIDDEN` : Accès interdit (ressource d'un autre utilisateur)
    - `ERR_NOT_FOUND` : Ressource non trouvée
    - `ERR_ACTIVITY_NOT_FOUND` : Activité non trouvée
    - `ERR_USER_NOT_FOUND` : Utilisateur non trouvé
    - `ERR_MEDIA_NOT_FOUND` : Média non trouvé
    - `ERR_VALIDATION` : Erreur de validation
    - `ERR_INVALID_ID` : ID MongoDB invalide
    - `ERR_MISSING_FIELDS` : Champs obligatoires manquants
    - `ERR_INVALID_FORMAT` : Format de données invalide
    - `ERR_CONFLICT` : Conflit (ressource déjà existante)
    - `ERR_EMAIL_EXISTS` : Email déjà utilisé
    - `ERR_DUPLICATE_RESOURCE` : Ressource dupliquée
    - `ERR_LIMIT_EXCEEDED` : Limite dépassée
    - `ERR_INTERNAL` : Erreur interne du serveur
    - `ERR_DATABASE` : Erreur base de données
    - `ERR_RATE_LIMIT` : Limite de requêtes dépassée

    ## Technologies

    - **Backend** : Express.js 5.1.0 (Node.js ES modules)
    - **Base de données** : MongoDB 8.19.1 avec Mongoose
    - **Authentification** : JWT (jsonwebtoken 9.0.2), bcrypt 6.0.0
    - **WebSocket** : wsmini 1.2.0 (500 clients max, 50KB max input)
    - **Compression GPS** : @mapbox/polyline 1.2.1 (réduction ~50% de la taille)
    - **Météo** : Open-Meteo API (forecast <7j, archive >7j)
    - **Tests** : Jest 30.2.0 + Supertest 7.1.4 (83% de couverture)

  contact:
    name: Support Track API
    email: support@track-api.com

servers:
  - url: http://localhost:3030/api
    description: Serveur de développement local
  - url: https://track-api.onrender.com/api
    description: Serveur de production

tags:
  - name: Auth
    description: Authentification et gestion de compte utilisateur
  - name: Activities
    description: CRUD des activités sportives avec enrichissement automatique
  - name: Medias
    description: Gestion des médias (photos/vidéos) associés aux activités
  - name: Users
    description: Statistiques utilisateur et records personnels

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Token JWT obtenu via `/auth/login`.
        Durée de validité : 7 jours.
        Format du header : `Authorization: Bearer <token>`

  schemas:
    # =============== USER SCHEMAS ===============
    User:
      type: object
      description: Schéma utilisateur complet (le mot de passe n'est jamais retourné)
      properties:
        _id:
          type: string
          format: objectId
          example: "507f1f77bcf86cd799439011"
        username:
          type: string
          minLength: 1
          example: "john_runner"
        email:
          type: string
          format: email
          example: "john@example.com"
          description: Format RFC 5322
        firstname:
          type: string
          minLength: 1
          example: "John"
        lastname:
          type: string
          minLength: 1
          example: "Doe"
        age:
          type: number
          minimum: 13
          maximum: 120
          example: 28
          nullable: true
        weight:
          type: number
          minimum: 0
          maximum: 500
          example: 70
          description: Poids en kg
          nullable: true
        activityStats:
          type: object
          description: Statistiques agrégées automatiquement à chaque création/suppression d'activité
          properties:
            totalKmEver:
              type: number
              minimum: 0
              example: 250.5
              description: Distance totale en kilomètres (toutes activités)
            totalKmYear:
              type: number
              minimum: 0
              example: 120.3
            totalKmMonth:
              type: number
              minimum: 0
              example: 42.1
            totalKmWeek:
              type: number
              minimum: 0
              example: 15.2
            totalTimeEver:
              type: number
              minimum: 0
              description: Temps total en secondes (toutes activités)
              example: 450000
            totalTimeYear:
              type: number
              minimum: 0
              example: 216000
            totalTimeMonth:
              type: number
              minimum: 0
              example: 75600
            totalTimeWeek:
              type: number
              minimum: 0
              example: 27360
            totalActivitiesEver:
              type: number
              minimum: 0
              example: 150
            totalActivitiesYear:
              type: number
              minimum: 0
              example: 72
            totalActivitiesMonth:
              type: number
              minimum: 0
              example: 25
            totalActivitiesWeek:
              type: number
              minimum: 0
              example: 6
            totalElevationEver:
              type: number
              minimum: 0
              description: Dénivelé positif total en mètres
              example: 12500
            totalElevationYear:
              type: number
              minimum: 0
              example: 6000
            totalElevationMonth:
              type: number
              minimum: 0
              example: 2100
            totalElevationWeek:
              type: number
              minimum: 0
              example: 750
            lastUpdated:
              type: string
              format: date-time
              description: Date de dernière mise à jour des stats
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - _id
        - username
        - email
        - firstname
        - lastname

    UserRegistration:
      type: object
      description: Données requises pour créer un compte
      properties:
        username:
          type: string
          minLength: 1
          example: "john_runner"
          description: Nom d'utilisateur unique
        email:
          type: string
          format: email
          example: "john@example.com"
          description: Email unique (validation RFC 5322)
        password:
          type: string
          minLength: 12
          example: "SecurePassword123!"
          description: Minimum 12 caractères (sera hashé avec bcrypt cost factor 13)
        firstname:
          type: string
          minLength: 1
          example: "John"
        lastname:
          type: string
          minLength: 1
          example: "Doe"
        age:
          type: number
          minimum: 13
          maximum: 120
          example: 28
          nullable: true
        weight:
          type: number
          minimum: 0
          maximum: 500
          example: 70
          description: Poids en kg (optionnel)
          nullable: true
      required:
        - username
        - email
        - password
        - firstname
        - lastname

    UserLogin:
      type: object
      description: Identifiants de connexion
      properties:
        email:
          type: string
          format: email
          example: "john@example.com"
        password:
          type: string
          example: "SecurePassword123!"
      required:
        - email
        - password

    UserUpdateCredentials:
      type: object
      description: Modification des identifiants (au moins un champ requis)
      properties:
        email:
          type: string
          format: email
          example: "newemail@example.com"
          description: Nouvel email (optionnel, doit être unique)
        password:
          type: string
          minLength: 12
          example: "NewSecurePassword123!"
          description: Nouveau mot de passe (optionnel, minimum 12 caractères)
        currentPassword:
          type: string
          example: "OldPassword123!"
          description: Mot de passe actuel (requis pour validation)
      required:
        - currentPassword

    # =============== ACTIVITY SCHEMAS ===============
    Activity:
      type: object
      description: |
        Activité sportive complète avec enrichissement automatique.
        Lors de la création :
        - Météo récupérée via Open-Meteo
        - Score de difficulté calculé (1.0-2.0)
        - Statistiques utilisateur mises à jour (yearly, monthly, weekly)
        - Records personnels vérifiés et mis à jour si battus
      properties:
        _id:
          type: string
          format: objectId
          example: "507f1f77bcf86cd799439011"
        userId:
          type: string
          format: objectId
          example: "507f191e810c19729de860ea"
          description: Référence à l'utilisateur propriétaire
        date:
          type: string
          format: date-time
          example: "2024-12-17T10:30:00.000Z"
          description: Date de l'activité (indexée pour requêtes rapides)
        startedAt:
          type: string
          format: date-time
          example: "2024-12-17T10:30:00.000Z"
        stoppedAt:
          type: string
          format: date-time
          example: "2024-12-17T11:15:30.000Z"
          description: Doit être postérieure à startedAt
        duration:
          type: number
          description: Durée totale en secondes (pauses incluses)
          minimum: 0
          example: 2730
        moving_duration:
          type: number
          description: Durée en mouvement en secondes (pauses exclues)
          minimum: 0
          example: 2650
        distance:
          type: number
          description: Distance en mètres
          minimum: 0
          example: 10000
        avgPace:
          type: string
          description: Allure moyenne en min/km (format "M:SS")
          pattern: '^\d+:\d{2}$'
          example: "4:30"
          nullable: true
        laps:
          type: array
          description: Segments de l'activité (généralement 1 lap = 1 km)
          items:
            type: object
            properties:
              lap:
                type: number
                minimum: 1
                example: 1
                description: Numéro du lap
              distance:
                type: number
                minimum: 0
                example: 1000
                description: Distance du lap en mètres
              elevationGain:
                type: number
                minimum: 0
                example: 15
                description: Dénivelé positif du lap en mètres
              elevationLoss:
                type: number
                minimum: 0
                example: 8
                description: Dénivelé négatif du lap en mètres
              pace:
                type: string
                example: "4:25"
                description: Allure du lap en min/km
              started_at:
                type: number
                description: Timestamp Unix de début du lap (millisecondes)
                example: 1702811400000
              finished_at:
                type: number
                description: Timestamp Unix de fin du lap (millisecondes)
                example: 1702811665000
        elevationGain:
          type: number
          description: Dénivelé positif total en mètres
          minimum: 0
          example: 150
        elevationLoss:
          type: number
          description: Dénivelé négatif total en mètres
          minimum: 0
          example: 145
        altitude_max:
          type: number
          example: 450
          description: Altitude maximale en mètres
        altitude_min:
          type: number
          example: 320
          description: Altitude minimale en mètres
        altitude_avg:
          type: number
          example: 385
          description: Altitude moyenne en mètres
        startPosition:
          type: object
          description: Position de départ (format GeoJSON Point)
          properties:
            geometry:
              type: object
              properties:
                type:
                  type: string
                  enum: [Point]
                  example: "Point"
                coordinates:
                  type: array
                  description: "[longitude, latitude, altitude (optionnel)]"
                  items:
                    type: number
                  minItems: 2
                  maxItems: 3
                  example: [6.6327, 46.5197, 372]
              required:
                - type
                - coordinates
            timestamp:
              type: string
              format: date-time
            altitude:
              type: number
              example: 372
          required:
            - geometry
        endPosition:
          type: object
          description: Position d'arrivée (format GeoJSON Point)
          properties:
            geometry:
              type: object
              properties:
                type:
                  type: string
                  enum: [Point]
                  example: "Point"
                coordinates:
                  type: array
                  description: "[longitude, latitude, altitude (optionnel)]"
                  items:
                    type: number
                  minItems: 2
                  maxItems: 3
                  example: [6.6330, 46.5200, 370]
              required:
                - type
                - coordinates
            timestamp:
              type: string
              format: date-time
            altitude:
              type: number
              example: 370
          required:
            - geometry
        startPoint2dSphere:
          type: object
          description: Index géospatial 2dsphere (généré automatiquement)
          readOnly: true
        endPoint2dSphere:
          type: object
          description: Index géospatial 2dsphere (généré automatiquement)
          readOnly: true
        encodedPolyline:
          type: string
          description: |
            Tracé GPS compressé (format Google Polyline via @mapbox/polyline).
            Réduction ~50% de la taille par rapport à JSON brut.
          example: "u~w~Fs~{tE??AACC..."
          nullable: true
        totalPoints:
          type: number
          description: Nombre total de points GPS enregistrés
          minimum: 0
          example: 2730
        samplingRate:
          type: number
          description: Fréquence d'échantillonnage en points/seconde (typiquement 1)
          minimum: 0.1
          maximum: 60
          example: 1
        medias:
          type: array
          description: URLs Cloudinary des médias associés (max 10)
          maxItems: 10
          items:
            type: string
            format: uri
          example: ["https://res.cloudinary.com/demo/image/upload/v1234/sample.jpg"]
        weather:
          type: object
          description: |
            Données météo enrichies automatiquement via Open-Meteo.
            - Activités <7 jours : API forecast
            - Activités >7 jours : API archive
          nullable: true
          properties:
            temperature:
              type: number
              description: Température en °C
              example: 18.5
            humidity:
              type: number
              minimum: 0
              maximum: 100
              description: Humidité en %
              example: 65
            windSpeed:
              type: number
              minimum: 0
              description: Vitesse du vent en km/h
              example: 12
            conditions:
              type: string
              enum: [clear, cloudy, foggy, rainy, snowy, stormy]
              example: "clear"
              description: Conditions météo générales
            fetchedAt:
              type: string
              format: date-time
              description: Date de récupération des données météo
        difficultyScore:
          type: number
          description: |
            Score de difficulté global (1.0 = facile, 2.0 = très difficile).
            Calculé automatiquement basé sur dénivelé, météo, vent, température.
          minimum: 1.0
          maximum: 2.0
          example: 1.35
          readOnly: true
        difficultyFactors:
          type: object
          description: Détail du calcul du score de difficulté
          readOnly: true
          properties:
            baseScore:
              type: number
              example: 1.0
              description: Score de base (toujours 1.0)
            elevationBonus:
              type: number
              minimum: 0
              maximum: 0.4
              example: 0.15
              description: min(elevationGain / 500, 0.4)
            weatherBonus:
              type: number
              minimum: 0
              example: 0.1
              description: Orage/Grêle +0.1, Neige +0.08, Pluie +0.05
            windBonus:
              type: number
              minimum: 0
              example: 0.05
              description: Vent >40 km/h +0.2, >20 km/h +0.1
            temperatureBonus:
              type: number
              minimum: 0
              example: 0.05
              description: <0°C ou >32°C +0.15, <5°C ou >28°C +0.08
        estimatedCalories:
          type: number
          description: Calories estimées brûlées
          minimum: 0
          example: 750
        createdAt:
          type: string
          format: date-time
          readOnly: true
        updatedAt:
          type: string
          format: date-time
          readOnly: true
      required:
        - userId
        - date
        - startedAt
        - stoppedAt
        - duration
        - moving_duration
        - distance
        - avgPace
        - laps
        - elevationGain
        - elevationLoss
        - altitude_min
        - altitude_max
        - altitude_avg
        - startPosition
        - endPosition
        - encodedPolyline
        - totalPoints
        - samplingRate
        - estimatedCalories

    ActivityCreate:
      type: object
      description: Données requises pour créer une activité
      properties:
        date:
          type: string
          format: date-time
          example: "2024-12-17T10:30:00.000Z"
        startedAt:
          type: string
          format: date-time
          example: "2024-12-17T10:30:00.000Z"
        stoppedAt:
          type: string
          format: date-time
          example: "2024-12-17T11:15:30.000Z"
          description: Doit être après startedAt
        duration:
          type: number
          minimum: 0
          example: 2730
          description: Durée totale en secondes
        moving_duration:
          type: number
          minimum: 0
          example: 2650
          description: Durée en mouvement (pauses exclues) en secondes
        distance:
          type: number
          minimum: 0
          example: 10000
          description: Distance en mètres
        avgPace:
          type: string
          example: "4:30"
          pattern: '^\d+:\d{2}$'
          description: Allure moyenne en min/km
        laps:
          type: array
          items:
            type: object
            properties:
              lap:
                type: number
                minimum: 1
              distance:
                type: number
                minimum: 0
              elevationGain:
                type: number
                minimum: 0
              elevationLoss:
                type: number
                minimum: 0
              pace:
                type: string
              started_at:
                type: number
                description: Timestamp Unix (millisecondes)
              finished_at:
                type: number
                description: Timestamp Unix (millisecondes)
        elevationGain:
          type: number
          minimum: 0
          example: 150
          description: Dénivelé positif en mètres
        elevationLoss:
          type: number
          minimum: 0
          example: 145
          description: Dénivelé négatif en mètres
        altitude_max:
          type: number
          example: 450
        altitude_min:
          type: number
          example: 320
        altitude_avg:
          type: number
          example: 385
        startPosition:
          type: object
          properties:
            geometry:
              type: object
              properties:
                type:
                  type: string
                  enum: [Point]
                coordinates:
                  type: array
                  description: "[longitude, latitude, altitude (optionnel)]"
                  items:
                    type: number
                  minItems: 2
                  maxItems: 3
                  example: [6.6327, 46.5197, 372]
              required:
                - type
                - coordinates
            timestamp:
              type: string
              format: date-time
            altitude:
              type: number
          required:
            - geometry
        endPosition:
          type: object
          properties:
            geometry:
              type: object
              properties:
                type:
                  type: string
                  enum: [Point]
                coordinates:
                  type: array
                  items:
                    type: number
                  minItems: 2
                  maxItems: 3
                  example: [6.6330, 46.5200, 370]
              required:
                - type
                - coordinates
            timestamp:
              type: string
              format: date-time
            altitude:
              type: number
          required:
            - geometry
        encodedPolyline:
          type: string
          description: Polyline encodée (@mapbox/polyline)
          example: "u~w~Fs~{tE??AACC..."
        totalPoints:
          type: number
          minimum: 0
          example: 2730
        samplingRate:
          type: number
          minimum: 0.1
          maximum: 60
          example: 1
        estimatedCalories:
          type: number
          minimum: 0
          example: 750
      required:
        - date
        - startedAt
        - stoppedAt
        - duration
        - moving_duration
        - distance
        - avgPace
        - laps
        - elevationGain
        - elevationLoss
        - altitude_min
        - altitude_max
        - altitude_avg
        - startPosition
        - endPosition
        - encodedPolyline
        - totalPoints
        - samplingRate
        - estimatedCalories

    ActivityUpdate:
      type: object
      description: |
        Seuls certains champs sont modifiables après création.
        Au moins un champ doit être fourni.
      properties:
        medias:
          type: array
          items:
            type: string
            format: uri
          maxItems: 10
          description: URLs Cloudinary (max 10)
        elevationGain:
          type: number
          minimum: 0
          description: Correction manuelle du dénivelé positif
        elevationLoss:
          type: number
          minimum: 0
          description: Correction manuelle du dénivelé négatif
        estimatedCalories:
          type: number
          minimum: 0
          description: Correction manuelle des calories

    # =============== STATISTICS SCHEMAS ===============
    YearlyStats:
      type: object
      description: |
        Statistiques annuelles d'un utilisateur.
        Mises à jour automatiquement à chaque création/suppression d'activité.
      properties:
        _id:
          type: string
          format: objectId
        userId:
          type: string
          format: objectId
        year:
          type: number
          minimum: 2000
          maximum: 2100
          example: 2024
        totalKm:
          type: number
          minimum: 0
          example: 1250.5
          description: Distance totale en km
        totalActivities:
          type: number
          minimum: 0
          example: 145
        totalTime:
          type: number
          description: Temps total en secondes
          minimum: 0
          example: 540000
        totalElevation:
          type: number
          description: Dénivelé positif total en mètres
          minimum: 0
          example: 15000
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    MonthlyStats:
      type: object
      description: Statistiques mensuelles d'un utilisateur
      properties:
        _id:
          type: string
          format: objectId
        userId:
          type: string
          format: objectId
        year:
          type: number
          minimum: 2000
          maximum: 2100
          example: 2024
        month:
          type: number
          minimum: 1
          maximum: 12
          example: 12
          description: Mois (1-12)
        totalKm:
          type: number
          minimum: 0
          example: 120.3
        totalActivities:
          type: number
          minimum: 0
          example: 15
        totalTime:
          type: number
          minimum: 0
          example: 54000
          description: Temps total en secondes
        totalElevation:
          type: number
          minimum: 0
          example: 1500
          description: Dénivelé positif en mètres
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    WeeklyStats:
      type: object
      description: Statistiques hebdomadaires d'un utilisateur (semaines ISO 8601)
      properties:
        _id:
          type: string
          format: objectId
        userId:
          type: string
          format: objectId
        year:
          type: number
          minimum: 2000
          maximum: 2100
          example: 2024
        month:
          type: number
          minimum: 1
          maximum: 12
          example: 12
        week:
          type: number
          minimum: 1
          maximum: 53
          example: 50
          description: Numéro de semaine ISO 8601
        totalKm:
          type: number
          minimum: 0
          example: 35.2
        totalActivities:
          type: number
          minimum: 0
          example: 4
        totalTime:
          type: number
          minimum: 0
          example: 15840
        totalElevation:
          type: number
          minimum: 0
          example: 450
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    BestPerformances:
      type: object
      description: |
        Records personnels sur une distance donnée.
        Mis à jour automatiquement si un nouveau record est battu lors de la création d'activité.
        Distances de référence : 5000m (5K), 10000m (10K), 21097.5m (Semi-Marathon), 42195m (Marathon).
        Calcul par interpolation linéaire dans les laps si distance exacte non atteinte.
      properties:
        _id:
          type: string
          format: objectId
        userId:
          type: string
          format: objectId
        distance:
          type: number
          description: Distance de référence en mètres
          enum: [5000, 10000, 21097.5, 42195]
          example: 10000
        bestPerformance:
          type: object
          description: Meilleure performance actuelle
          properties:
            chrono:
              type: number
              description: Temps en secondes
              example: 2730
            date:
              type: string
              format: date-time
            activityId:
              type: string
              format: objectId
        performanceHistory:
          type: array
          description: Historique des anciens records
          items:
            type: object
            properties:
              chrono:
                type: number
                example: 2850
              date:
                type: string
                format: date-time
              activityId:
                type: string
                format: objectId
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # =============== RESPONSE SCHEMAS ===============
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          description: Données de la réponse
        meta:
          type: object
          description: Métadonnées (pagination, compteurs, etc.)
      required:
        - success
        - data

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            message:
              type: string
              example: "Une erreur est survenue"
            code:
              type: string
              example: "ERR_INTERNAL"
              description: Code d'erreur standardisé (voir liste dans description de l'API)
            details:
              type: array
              items:
                type: string
              description: Détails supplémentaires (champs manquants, erreurs de validation, etc.)
      required:
        - success
        - error

paths:
  # =============== AUTH ENDPOINTS ===============
  /auth/create-account:
    post:
      tags:
        - Auth
      summary: Créer un compte utilisateur
      description: |
        Crée un nouveau compte utilisateur avec validation stricte.

        **Processus :**
        1. Validation des champs (email RFC 5322, password ≥12 chars)
        2. Vérification unicité email
        3. Hash du mot de passe (bcrypt cost factor 13)
        4. Création de l'utilisateur
        5. Initialisation des statistiques (yearly, monthly, weekly)

        **Rate Limit :** 10 tentatives par heure par IP
      operationId: createAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistration'
            examples:
              complet:
                summary: Inscription complète avec âge et poids
                value:
                  username: "john_runner"
                  email: "john@example.com"
                  password: "SecurePassword123!"
                  firstname: "John"
                  lastname: "Doe"
                  age: 28
                  weight: 70
              minimal:
                summary: Inscription minimale (champs requis uniquement)
                value:
                  username: "jane_doe"
                  email: "jane@example.com"
                  password: "AnotherSecurePass123!"
                  firstname: "Jane"
                  lastname: "Doe"
      responses:
        '201':
          description: Compte créé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Utilisateur ajouté avec succès"
                      id:
                        type: string
                        format: objectId
                        example: "507f1f77bcf86cd799439011"
        '409':
          description: Email déjà utilisé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "This Email is already associated with an existing account"
                  code: "ERR_EMAIL_EXISTS"
        '422':
          description: Validation échouée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEmail:
                  summary: Format email invalide
                  value:
                    success: false
                    error:
                      message: "Veuillez entrer une adresse mail valide"
                      code: "ERR_VALIDATION"
                passwordTooShort:
                  summary: Mot de passe trop court
                  value:
                    success: false
                    error:
                      message: "Le mot de passe doit contenir minimum 12 caractères"
                      code: "ERR_VALIDATION"
        '429':
          description: Rate limit dépassé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "Trop de tentatives de création de compte. Veuillez réessayer plus tard."
                  code: "ERR_RATE_LIMIT"
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - Auth
      summary: Se connecter
      description: |
        Authentifie un utilisateur et retourne un JWT.

        **JWT :**
        - Durée de validité : 7 jours
        - Algorithme : HS256
        - Payload : `{ sub: userId, iat, exp }`

        **Rate Limit :** 20 tentatives par 5 minutes par IP
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLogin'
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      token:
                        type: string
                        description: JWT à inclure dans le header Authorization
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        '401':
          description: Identifiants incorrects
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "Email ou mot de passe incorrect"
                  code: "ERR_INVALID_CREDENTIALS"
        '422':
          description: Validation échouée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit dépassé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "Trop de tentatives de connexion. Veuillez réessayer dans 5 minutes."
                  code: "ERR_RATE_LIMIT"
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/update-account:
    post:
      tags:
        - Auth
      summary: Modifier les identifiants
      description: |
        Modifie l'email et/ou le mot de passe de l'utilisateur.
        Le mot de passe actuel est requis pour validation de sécurité.
        Au moins un champ (email ou password) doit être fourni.
      operationId: updateAccount
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateCredentials'
            examples:
              changeEmail:
                summary: Changer uniquement l'email
                value:
                  email: "newemail@example.com"
                  currentPassword: "CurrentPassword123!"
              changePassword:
                summary: Changer uniquement le mot de passe
                value:
                  password: "NewSecurePassword456!"
                  currentPassword: "CurrentPassword123!"
              changeBoth:
                summary: Changer email et mot de passe
                value:
                  email: "newemail@example.com"
                  password: "NewSecurePassword456!"
                  currentPassword: "CurrentPassword123!"
      responses:
        '200':
          description: Identifiants mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Identifiants mis à jour avec succès"
        '400':
          description: Aucune modification ou validation échouée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié ou mot de passe actuel incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Utilisateur non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Nouvel email déjà utilisé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/delete-account:
    delete:
      tags:
        - Auth
      summary: Supprimer le compte
      description: |
        Supprime définitivement le compte et toutes les données associées.

        **Données supprimées (transaction MongoDB) :**
        - Utilisateur
        - Toutes les activités
        - Toutes les statistiques (yearly, monthly, weekly)
        - Tous les records personnels

        **Sécurité :** Mot de passe actuel requis pour confirmation.

        **⚠️ Opération irréversible**
      operationId: deleteAccount
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
                  example: "MyCurrentPassword123!"
                  description: Mot de passe actuel pour confirmation
              required:
                - password
      responses:
        '200':
          description: Compte supprimé
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Compte supprimé avec succès"
        '401':
          description: Mot de passe incorrect ou manquant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Utilisateur non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # =============== ACTIVITIES ENDPOINTS ===============
  /activities:
    get:
      tags:
        - Activities
      summary: Lister les activités
      description: |
        Récupère toutes les activités de l'utilisateur authentifié.

        **Fonctionnalités :**
        - **Pagination** : `page` (défaut 1) et `limit` (défaut 20, max 100)
        - **Tri** : `sort` par date/distance/duration (préfixe `-` pour ordre décroissant)
        - **Filtres** : par plage de dates et de distance

        **Index MongoDB** : Requêtes optimisées via index composé `{ userId: 1, date: -1 }`
      operationId: getUserActivities
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          description: Numéro de page
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Activités par page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: sort
          in: query
          description: Champ de tri (préfixe `-` pour décroissant)
          schema:
            type: string
            enum: [date, -date, distance, -distance, duration, -duration]
            default: -date
        - name: startDate
          in: query
          description: Date de début (ISO 8601)
          schema:
            type: string
            format: date-time
            example: "2024-01-01T00:00:00.000Z"
        - name: endDate
          in: query
          description: Date de fin (ISO 8601)
          schema:
            type: string
            format: date-time
            example: "2024-12-31T23:59:59.999Z"
        - name: minDistance
          in: query
          description: Distance minimale en mètres
          schema:
            type: number
            minimum: 0
            example: 5000
        - name: maxDistance
          in: query
          description: Distance maximale en mètres
          schema:
            type: number
            minimum: 0
            example: 15000
      responses:
        '200':
          description: Liste des activités
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Activity'
                  meta:
                    type: object
                    properties:
                      count:
                        type: integer
                        description: Nombre d'activités dans cette page
                        example: 20
                      total:
                        type: integer
                        description: Nombre total d'activités (tous filtres appliqués)
                        example: 145
                      page:
                        type: integer
                        example: 1
                      totalPages:
                        type: integer
                        example: 8
        '400':
          description: Paramètres invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Activities
      summary: Créer une activité
      description: |
        Crée une nouvelle activité avec enrichissement automatique.

        **Processus automatique :**
        1. Validation des champs obligatoires
        2. Vérification propriété de l'utilisateur
        3. **Enrichissement météo** via Open-Meteo (forecast <7j, archive >7j)
        4. **Calcul score de difficulté** (1.0-2.0) basé sur :
           - Dénivelé : min(elevationGain / 500, 0.4)
           - Vent : >40 km/h (+0.2), >20 km/h (+0.1)
           - Température : <0°C ou >32°C (+0.15), <5°C ou >28°C (+0.08)
           - Météo : Orage/Grêle (+0.1), Neige (+0.08), Pluie (+0.05)
        5. **Mise à jour statistiques** (User.activityStats + YearlyStats + MonthlyStats + WeeklyStats)
        6. **Vérification records personnels** (5K, 10K, Semi, Marathon)
        7. **Broadcast WebSocket** (totaux communauté)

        **Validations :**
        - `stoppedAt` > `startedAt`
        - Positions GeoJSON valides `[longitude, latitude, altitude?]`
        - Max 10 médias

        **Index géospatiaux** : startPoint2dSphere et endPoint2dSphere créés automatiquement
      operationId: createActivity
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityCreate'
      responses:
        '201':
          description: Activité créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Activité crée avec succès"
                      activity:
                        $ref: '#/components/schemas/Activity'
                      recordsBroken:
                        type: array
                        description: Liste des records battus (si applicable)
                        items:
                          type: object
                          properties:
                            distance:
                              type: number
                              example: 10000
                              description: Distance du record en mètres
                            distanceLabel:
                              type: string
                              example: "10K"
                            previousChrono:
                              type: number
                              example: 2850
                              description: Ancien record en secondes
                            previousChronoFormatted:
                              type: string
                              example: "47:30"
                            previousPace:
                              type: string
                              example: "4:45"
                            newChrono:
                              type: number
                              example: 2730
                            newChronoFormatted:
                              type: string
                              example: "45:30"
                            newPace:
                              type: string
                              example: "4:33"
                            improvement:
                              type: number
                              example: 120
                              description: Amélioration en secondes
                            improvementFormatted:
                              type: string
                              example: "2:00"
        '400':
          description: Validation échouée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingFields:
                  summary: Champs obligatoires manquants
                  value:
                    success: false
                    error:
                      message: "Champs obligatoires manquants"
                      code: "ERR_MISSING_FIELDS"
                      details: ["date", "distance", "duration"]
                invalidPosition:
                  summary: Format position invalide
                  value:
                    success: false
                    error:
                      message: "Format de startPosition invalide. Format attendu: { geometry: { type: 'Point', coordinates: [longitude, latitude] } }"
                      code: "ERR_INVALID_FORMAT"
                invalidTiming:
                  summary: stoppedAt avant startedAt
                  value:
                    success: false
                    error:
                      message: "Erreur de validation"
                      code: "ERR_VALIDATION"
                      details: ["stoppedAt must be after startedAt"]
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Utilisateur non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /activities/{id}:
    get:
      tags:
        - Activities
      summary: Récupérer une activité
      description: |
        Récupère les détails complets d'une activité.
        L'utilisateur ne peut accéder qu'à ses propres activités.
      operationId: getActivityById
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID MongoDB de l'activité
          schema:
            type: string
            format: objectId
            example: "507f1f77bcf86cd799439011"
      responses:
        '200':
          description: Détails de l'activité
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Activity'
        '400':
          description: ID invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit (activité d'un autre utilisateur)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Activité non trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - Activities
      summary: Modifier une activité
      description: |
        Modifie certains champs d'une activité existante.

        **Champs modifiables (whitelist) :**
        - `medias` : URLs Cloudinary (max 10)
        - `elevationGain` : Correction manuelle du dénivelé positif
        - `elevationLoss` : Correction manuelle du dénivelé négatif
        - `estimatedCalories` : Correction manuelle des calories

        **Restrictions :**
        - L'utilisateur ne peut modifier que ses propres activités
        - Au moins un champ modifiable doit être fourni
        - Les statistiques ne sont **PAS** recalculées (seule la création/suppression met à jour les stats)
      operationId: updateActivity
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID de l'activité
          schema:
            type: string
            format: objectId
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityUpdate'
            examples:
              updateMedias:
                summary: Ajouter/modifier des médias
                value:
                  medias:
                    - "https://res.cloudinary.com/demo/image/upload/v1234/photo1.jpg"
                    - "https://res.cloudinary.com/demo/image/upload/v1234/photo2.jpg"
              correctElevation:
                summary: Corriger le dénivelé
                value:
                  elevationGain: 175
                  elevationLoss: 160
      responses:
        '200':
          description: Activité mise à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Activité mise à jour avec succès"
                      activity:
                        $ref: '#/components/schemas/Activity'
        '400':
          description: Validation échouée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noField:
                  summary: Aucun champ modifiable fourni
                  value:
                    success: false
                    error:
                      message: "Aucun champ modifiable fourni"
                      code: "ERR_VALIDATION"
                      details: ["medias", "elevationGain", "elevationLoss", "estimatedCalories"]
                tooManyMedias:
                  summary: Limite médias dépassée
                  value:
                    success: false
                    error:
                      message: "Maximum 10 médias autorisés par activité"
                      code: "ERR_LIMIT_EXCEEDED"
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Activité non trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Activities
      summary: Supprimer une activité
      description: |
        Supprime définitivement une activité.

        **Mise à jour automatique (transaction MongoDB) :**
        - Décrémente les statistiques User.activityStats
        - Décrémente les statistiques YearlyStats, MonthlyStats, WeeklyStats
        - Supprime l'activité

        **⚠️ Note :** Les records personnels ne sont **PAS** recalculés automatiquement.
      operationId: deleteActivity
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID de l'activité
          schema:
            type: string
            format: objectId
      responses:
        '200':
          description: Activité supprimée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Activité supprimée avec succès"
                      deletedActivityId:
                        type: string
                        format: objectId
                        example: "507f1f77bcf86cd799439011"
        '400':
          description: ID invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Activité non trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # =============== MEDIAS ENDPOINTS ===============
  /medias/all:
    get:
      tags:
        - Medias
      summary: Lister tous les médias
      description: |
        Récupère tous les médias de toutes les activités de l'utilisateur authentifié.

        **Note :** Les images sont uploadées directement sur Cloudinary côté frontend.
        Le backend stocke uniquement les URLs dans le champ `medias` des activités.
      operationId: getActivitiesMedias
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Liste des médias groupés par activité
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        activityId:
                          type: string
                          format: objectId
                        date:
                          type: string
                          format: date-time
                        medias:
                          type: array
                          items:
                            type: string
                            format: uri
                  meta:
                    type: object
                    properties:
                      totalActivitiesWithMedias:
                        type: integer
                        example: 25
                      totalMedias:
                        type: integer
                        example: 78
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /medias/{activityId}:
    get:
      tags:
        - Medias
      summary: Récupérer les médias d'une activité
      description: Récupère tous les médias d'une activité spécifique
      operationId: getActivityMedias
      security:
        - BearerAuth: []
      parameters:
        - name: activityId
          in: path
          required: true
          description: ID de l'activité
          schema:
            type: string
            format: objectId
      responses:
        '200':
          description: Médias de l'activité
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      activityId:
                        type: string
                        format: objectId
                      date:
                        type: string
                        format: date-time
                      totalMedias:
                        type: integer
                        example: 3
                      medias:
                        type: array
                        items:
                          type: string
                          format: uri
        '400':
          description: ID activité invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Activité non trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Medias
      summary: Ajouter un média
      description: |
        Ajoute une URL de média (Cloudinary) à une activité.

        **Limitations :**
        - Maximum 10 médias par activité
        - Le média ne doit pas déjà exister pour cette activité
        - L'utilisateur doit être propriétaire de l'activité
      operationId: addMediaToActivity
      security:
        - BearerAuth: []
      parameters:
        - name: activityId
          in: path
          required: true
          description: ID de l'activité
          schema:
            type: string
            format: objectId
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mediaUrl:
                  type: string
                  format: uri
                  example: "https://res.cloudinary.com/demo/image/upload/v1234/sample.jpg"
                  description: URL Cloudinary du média
              required:
                - mediaUrl
      responses:
        '201':
          description: Média ajouté
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Média ajouté avec succès"
                      activityId:
                        type: string
                        format: objectId
                      totalMedias:
                        type: integer
                        example: 4
                      medias:
                        type: array
                        items:
                          type: string
                          format: uri
        '400':
          description: Validation échouée ou limite atteinte
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                limitExceeded:
                  summary: Limite de 10 médias atteinte
                  value:
                    success: false
                    error:
                      message: "Maximum de 10 médias atteint pour cette activité"
                      code: "ERR_LIMIT_EXCEEDED"
        '403':
          description: Accès interdit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Activité non trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Média déjà existant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  message: "Ce média est déjà associé à cette activité"
                  code: "ERR_CONFLICT"
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Medias
      summary: Supprimer un média
      description: |
        Supprime un média spécifique d'une activité par son URL.
        L'utilisateur doit être propriétaire de l'activité.
      operationId: deleteMediaFromActivity
      security:
        - BearerAuth: []
      parameters:
        - name: activityId
          in: path
          required: true
          description: ID de l'activité
          schema:
            type: string
            format: objectId
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mediaUrl:
                  type: string
                  format: uri
                  example: "https://res.cloudinary.com/demo/image/upload/v1234/sample.jpg"
                  description: URL du média à supprimer
              required:
                - mediaUrl
      responses:
        '200':
          description: Média supprimé
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Média supprimé avec succès"
                      activityId:
                        type: string
                        format: objectId
                      totalMedias:
                        type: integer
                        example: 3
                      medias:
                        type: array
                        items:
                          type: string
                          format: uri
        '400':
          description: Validation échouée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Activité ou média non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                activityNotFound:
                  summary: Activité non trouvée
                  value:
                    success: false
                    error:
                      message: "Activité non trouvée"
                      code: "ERR_ACTIVITY_NOT_FOUND"
                mediaNotFound:
                  summary: Média non trouvé dans cette activité
                  value:
                    success: false
                    error:
                      message: "Ce média n'existe pas pour cette activité"
                      code: "ERR_MEDIA_NOT_FOUND"
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # =============== USERS ENDPOINTS ===============
  /users/user:
    get:
      tags:
        - Users
      summary: Récupérer le profil utilisateur
      description: |
        Récupère les informations complètes du profil de l'utilisateur authentifié.
        Le mot de passe n'est jamais retourné (sélection explicite `-password`).
      operationId: getUserInfos
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Informations utilisateur
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/yearly:
    get:
      tags:
        - Users
      summary: Statistiques annuelles
      description: |
        Récupère toutes les statistiques annuelles de l'utilisateur authentifié.
        Une entrée par année où l'utilisateur a enregistré au moins une activité.
      operationId: getYearlyStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Statistiques annuelles
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/YearlyStats'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/monthly:
    get:
      tags:
        - Users
      summary: Statistiques mensuelles
      description: |
        Récupère toutes les statistiques mensuelles de l'utilisateur authentifié.
        Une entrée par mois où l'utilisateur a enregistré au moins une activité.
      operationId: getMonthlyStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Statistiques mensuelles
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MonthlyStats'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/weekly:
    get:
      tags:
        - Users
      summary: Statistiques hebdomadaires
      description: |
        Récupère toutes les statistiques hebdomadaires de l'utilisateur authentifié.
        Semaines au format ISO 8601 (numéro de semaine 1-53).
      operationId: getWeeklyStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Statistiques hebdomadaires
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WeeklyStats'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/best-performances:
    get:
      tags:
        - Users
      summary: Records personnels
      description: |
        Récupère tous les records personnels de l'utilisateur.

        **Distances de référence :**
        - 5000m (5K)
        - 10000m (10K)
        - 21097.5m (Semi-Marathon)
        - 42195m (Marathon)

        **Calcul :** Interpolation linéaire dans les laps si distance exacte non atteinte.

        **Mise à jour :** Automatique à chaque création d'activité si record battu.
      operationId: getBestPerformances
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Records personnels
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/BestPerformances'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
